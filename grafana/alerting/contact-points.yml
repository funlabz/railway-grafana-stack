apiVersion: 1

contactPoints:
  # -------------------------
  # Flow errors → engineering Slack
  # -------------------------
  - orgId: 1
    name: polybot-flow-slack
    receivers:
      - uid: polybot_flow_slack
        type: slack
        disableResolveMessage: false
        settings:
          recipient: "${POLYBOT_SLACK_CHANNEL}"
          url: "${POLYBOT_SLACK_WEBHOOK_URL}"
          title: '{{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else }}Grafana Alert{{ end }}'
          text: |
            {{- range .Alerts }}
            *Alert:* {{ if .Labels.alertname }}{{ .Labels.alertname }}{{ else }}Grafana Alert{{ end }}
            *Severity:* {{ if .Labels.severity }}{{ .Labels.severity }}{{ else }}n/a{{ end }}
            *Component:* {{ if .Labels.component }}{{ .Labels.component }}{{ else }}n/a{{ end }}
            {{- if .GeneratorURL }}
            *Alert URL:* <{{ .GeneratorURL }}|Open alert view>
            {{- end }}

            {{- if .Labels.metric }}
            *Payload:* {{ .Labels.metric }}
            {{- end }}

            {{- if .Annotations.details }}
            *Details:* {{ .Annotations.details }}
            {{- end }}
            {{- end }}
          color: '{{ if eq .CommonLabels.severity "critical" }}#E02F44{{ else if or (eq .CommonLabels.severity "error") (eq .CommonLabels.severity "warning") }}#FFB347{{ else }}#36A64F{{ end }}'

  # -------------------------
  # Trades → business Slack
  # -------------------------
  - orgId: 1
    name: polybot-trade-slack
    receivers:
      - uid: polybot_trade_slack
        type: slack
        disableResolveMessage: false
        settings:
          recipient: "${POLYBOT_BUSINESS_SLACK_CHANNEL}"
          url: "${POLYBOT_BUSINESS_SLACK_WEBHOOK_URL}"
          title: '{{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else }}Grafana Alert{{ end }}'
          text: |
            {{- range .Alerts }}
            {{- $tradeVals := or (index .Values "D") (index .Values "D0") (index .Values "E") (index .Values "E0") -}}
            {{- $payload := dict -}}
            {{- if $tradeVals -}}
            {{- $payload = fromJson (default "{}" (index $tradeVals.Labels "metric")) -}}
            {{- end }}
            {{- $handle := or .Labels.user_handle (index $payload "user_handle") (index .Annotations "user_handle") -}}
            {{- $market := or .Labels.market_slug (index $payload "market_slug") (index .Annotations "market_slug") -}}
            {{- $amount := or .Labels.amount_usd (index $payload "amount_usd") (index .Annotations "amount_usd") -}}
            {{- $userID := or .Labels.user_id (index $payload "user_id") (index .Annotations "user_id") -}}
            {{- $currency := or (index $payload "currency") "USDC" -}}
            *Alert:* {{ if .Labels.alertname }}{{ .Labels.alertname }}{{ else }}Grafana Alert{{ end }}
            *Severity:* {{ if .Labels.severity }}{{ .Labels.severity }}{{ else }}n/a{{ end }}
            *Component:* {{ if .Labels.component }}{{ .Labels.component }}{{ else }}n/a{{ end }}
            {{- if .GeneratorURL }}
            *Alert URL:* <{{ .GeneratorURL }}|Open alert view>
            {{- end }}

            {{- if $handle }}
            *Handle:* {{ $handle }}
            {{- end }}
            {{- if $market }}
            *Market:* {{ $market }}
            {{- end }}
            {{- if $amount }}
            *Amount ({{ $currency }}):* {{ $amount }}
            {{- end }}
            {{- if $userID }}
            *User ID:* {{ $userID }}
            {{- end }}
            {{- if $tradeVals }}
            {{- $metricJSON := default "" (index $tradeVals.Labels "metric") -}}
            {{- if $metricJSON }}
            *Payload:* {{ $metricJSON }}
            {{- end }}
            {{- end }}

            {{- if .Annotations.summary }}
            *Summary:* {{ .Annotations.summary }}
            {{- end }}
            {{- if .Annotations.details }}
            *Details:* {{ .Annotations.details }}
            {{- end }}
            {{- end }}
          color: '{{ if eq .CommonLabels.severity "critical" }}#E02F44{{ else if or (eq .CommonLabels.severity "error") (eq .CommonLabels.severity "warning") }}#FFB347{{ else }}#36A64F{{ end }}'

  # -------------------------
  # New users → business Slack
  # -------------------------
  - orgId: 1
    name: polybot-user-slack
    receivers:
      - uid: polybot_user_slack
        type: slack
        disableResolveMessage: false
        settings:
          recipient: "${POLYBOT_BUSINESS_SLACK_CHANNEL}"
          url: "${POLYBOT_BUSINESS_SLACK_WEBHOOK_URL}"
          title: '{{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else }}Grafana Alert{{ end }}'
          text: |
            {{- range .Alerts }}
            *Alert:* {{ if .Labels.alertname }}{{ .Labels.alertname }}{{ else }}Grafana Alert{{ end }}
            *Severity:* {{ if .Labels.severity }}{{ .Labels.severity }}{{ else }}n/a{{ end }}
            *Component:* {{ if .Labels.component }}{{ .Labels.component }}{{ else }}n/a{{ end }}
            {{- if .GeneratorURL }}
            *Alert URL:* <{{ .GeneratorURL }}|Open alert view>
            {{- end }}

            {{- if .Labels.user_count_str }}
            *New users:* {{ .Labels.user_count_str }}
            {{- end }}
            {{- if .Labels.users }}
            *Users:* {{ .Labels.users }}
            {{- end }}

            {{- if .Annotations.summary }}
            *Summary:* {{ .Annotations.summary }}
            {{- end }}
            {{- if .Annotations.details }}
            *Details:* {{ .Annotations.details }}
            {{- end }}
            {{- end }}
          color: '{{ if eq .CommonLabels.severity "critical" }}#E02F44{{ else if or (eq .CommonLabels.severity "error") (eq .CommonLabels.severity "warning") }}#FFB347{{ else }}#36A64F{{ end }}'
