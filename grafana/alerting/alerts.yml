apiVersion: 1

groups:
  - orgId: 1
    name: Polybot Flow Alerts
    folder: Observability
    interval: 30s
    rules:
      # -------------------------
      # 1. Flow error alert
      # -------------------------
      - uid: builtin_polybot_flow_errors
        interval: 30s
        title: Polybot Flow Error Detected
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 120   # 2 minutes
              to: 0
            datasourceUid: grafana_postgres
            model:
              datasource:
                type: postgres
                uid: grafana_postgres
              format: time_series
              intervalMs: 1000
              maxDataPoints: 43200
              rawSql: |
                WITH recent_error AS (
                  SELECT
                    "createdAt",
                    COALESCE("flow", 'unknown') AS flow_name,
                    COALESCE("stage", 'unknown') AS stage_name,
                    COALESCE(("context"::jsonb ->> 'class'), 'unknown') AS error_class,
                    LEFT(COALESCE("message", '(no message provided)'), 200) AS error_message
                  FROM "FlowEvent"
                  WHERE "createdAt" >= NOW() - INTERVAL '2 minutes'
                    AND UPPER("level") = 'ERROR'
                  ORDER BY "createdAt" DESC
                  LIMIT 1
                )
                SELECT
                  recent_error."createdAt" AS "time",
                  CONCAT(
                    'flow=', recent_error.flow_name,
                    ' | stage=', recent_error.stage_name,
                    ' | class=', recent_error.error_class,
                    ' | message=', recent_error.error_message
                  ) AS metric,
                  1::double precision AS value
                FROM recent_error
                ORDER BY 1;
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              type: classic_conditions
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    type: last
                  type: query
              intervalMs: 1000
              maxDataPoints: 43200
        noDataState: OK
        executionErrorState: Error
        for: 0s
        annotations:
          summary: Polybot flow errors detected during the last 2 minutes
          details: Most recent flow, stage, class, and message are embedded in the firing series payload
        labels:
          severity: error
          component: polybot-flow
        isPaused: false

      # -------------------------
      # 2. Trade executed alert
      # -------------------------
      - uid: builtin_polybot_trade_activity
        interval: 30s
        title: Polybot Trade Executed
        condition: E
        data:
          - refId: D
            relativeTimeRange:
              from: 120   # 2 minutes
              to: 0
            datasourceUid: grafana_postgres
            model:
              datasource:
                type: postgres
                uid: grafana_postgres
              format: time_series
              intervalMs: 1000
              maxDataPoints: 43200
              rawSql: |
                WITH latest_trade AS (
                  SELECT
                    te."timestamp" AS traded_at,
                    te."userId"::text AS user_id,
                    COALESCE(
                      u."telegramUsername",
                      u."telegramUserId"::text,
                      te."userId"::text,
                      'unknown'
                    ) AS user_handle,
                    COALESCE(te."marketSlug", 'unknown') AS market_slug,
                    ABS(COALESCE(te."costOrProceeds", te.shares * te.price, 0)) AS trade_value,
                    TO_CHAR(
                      ABS(COALESCE(te."costOrProceeds", te.shares * te.price, 0)),
                      'FM999999990.999999'
                    ) AS amount_usd
                  FROM "TradeExecution" te
                  LEFT JOIN "User" u ON u.id = te."userId"
                  WHERE te."timestamp" >= NOW() - INTERVAL '2 minutes'
                  ORDER BY te."timestamp" DESC
                  LIMIT 1
                )
                SELECT
                  latest_trade.traded_at AS "time",
                  CONCAT_WS(
                    '|',
                    'user_handle=' || latest_trade.user_handle,
                    'user_id=' || latest_trade.user_id,
                    'market_slug=' || latest_trade.market_slug,
                    'amount_usd=' || latest_trade.amount_usd,
                    'trade_value=' || latest_trade.trade_value,
                    'currency=USDC',
                    'traded_at=' || TO_CHAR(
                      latest_trade.traded_at AT TIME ZONE 'UTC',
                      'YYYY-MM-DD"T"HH24:MI:SS.MS"Z"'
                    )
                  ) AS metric,
                  latest_trade.trade_value::double precision AS value
                FROM latest_trade
                ORDER BY 1;
              refId: D
          - refId: E
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              type: classic_conditions
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - D
                  reducer:
                    type: last
                  type: query
              intervalMs: 1000
              maxDataPoints: 43200
        noDataState: OK
        executionErrorState: Error
        for: 0s
        annotations:
          summary: |
            {{- $series := or (index $values "D") (index $values "D0") -}}
            {{- if $series -}}
            {{- $metric := default "" (index $series.Labels "metric") -}}
            {{- $handle := regexFind "user_handle=([^|]+)" $metric -}}
            {{- if $handle -}}{{- $handle = regexReplaceAll "user_handle=" $handle "" -}}{{- else -}}{{- $handle = "unknown" -}}{{- end -}}
            {{- $market := regexFind "market_slug=([^|]+)" $metric -}}
            {{- if $market -}}{{- $market = regexReplaceAll "market_slug=" $market "" -}}{{- else -}}{{- $market = "unknown" -}}{{- end -}}
            {{- $amount := regexFind "amount_usd=([^|]+)" $metric -}}
            {{- if $amount -}}{{- $amount = regexReplaceAll "amount_usd=" $amount "" -}}{{- else -}}{{- $amount = "unknown" -}}{{- end -}}
            Trade by {{ $handle }} on {{ $market }} for {{ $amount }} USDC
            {{- else -}}
            No Polybot trades detected during the last 2 minutes
            {{- end -}}
          details: |
            {{- $series := or (index $values "D") (index $values "D0") -}}
            {{- if $series -}}
            Latest trade payload: {{ index $series.Labels "metric" }}
            {{- else -}}
            Waiting for next TradeExecution row within the last 2 minutes
            {{- end -}}
        labels:
          severity: info
          component: polybot-trade
        isPaused: false

      # -------------------------
      # 3. New user alert
      # -------------------------
      - uid: builtin_polybot_new_user
        interval: 30s
        title: Polybot New User Registered
        condition: H
        data:
          - refId: G
            relativeTimeRange:
              from: 120   # 2 minutes
              to: 0
            datasourceUid: grafana_postgres
            model:
              datasource:
                type: postgres
                uid: grafana_postgres
              format: table
              intervalMs: 1000
              maxDataPoints: 43200
              rawSql: |
                WITH new_users AS (
                  SELECT
                    u."createdAt" AS registered_at,
                    COALESCE(
                      u."telegramUsername",
                      u."telegramUserId"::text,
                      'unknown'
                    ) AS user_handle
                  FROM "User" u
                  WHERE u."createdAt" >= NOW() - INTERVAL '2 minutes'
                  ORDER BY u."createdAt" DESC
                  LIMIT 5
                )
                SELECT
                  COALESCE(MAX(new_users.registered_at), NOW()) AS registered_at,
                  COUNT(*)::double precision AS user_count,
                  COUNT(*)::text AS user_count_str,
                  COALESCE(string_agg(new_users.user_handle, ', '), 'none') AS users
                FROM new_users;
              refId: G
          - refId: H
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              type: classic_conditions
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - G
                  reducer:
                    type: last
                  type: query
              intervalMs: 1000
              maxDataPoints: 43200
        noDataState: OK
        executionErrorState: Error
        for: 0s
        annotations:
          summary: New Polybot user registered during the last 2 minutes
          details: Batch includes up to five freshest handles so celebratory alerts highlight who joined
        labels:
          severity: info
          component: polybot-user
        isPaused: false
